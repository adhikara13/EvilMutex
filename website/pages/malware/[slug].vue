<template>
  <div class="bg-darker min-h-screen text-green-400 font-mono">
    
    <div class="container mx-auto px-12 py-8">
      
      <div class="terminal-header p-2 mb-2">
        <div class="flex items-center justify-end">
          <button
            @click="goBack"
            class="interactive text-secondary hover:text-green-400 font-mono text-lg"
          >
            <span class="text-danger">←</span> Back to Search
          </button>
        </div>
      </div>

      
      <div v-if="!malware" class="terminal-body p-4">
        <div class="text-center">
          <div class="text-green-400 mb-4">
            <span class="text-danger">[</span>LOADING_MALWARE_PROFILE<span class="text-danger">]</span>
          </div>
          <pre class="text-sm text-secondary">
Accessing malware database...
Loading threat intelligence...
Parsing mutex signatures...
          </pre>
          <div class="loading-spinner w-8 h-8 mx-auto mt-4"></div>
        </div>
      </div>

      
      <div v-else class="terminal-body p-4">
        
        <div class="mb-6">
          <div class="flex items-center gap-4 mb-4">
            <div class="w-12 h-12 bg-danger border border-green-400 rounded flex items-center justify-center">
              <span class="text-green-400 text-lg">⚠</span>
            </div>
            <div>
              <h1 class="text-2xl font-bold text-green-400">
                {{ malware?.malware_info.family }}
              </h1>
              <div class="flex items-center gap-4 mt-1">
                <span class="badge badge-red">{{ malware?.category }}</span>
                <span class="text-warning text-sm">
                  {{ malware?.mutexes.length }} mutex signatures
                </span>
              </div>
            </div>
          </div>
        </div>

        
        <div class="grid grid-cols-1 xl:grid-cols-3 gap-8">
          
          <div class="xl:col-span-2 space-y-8">
            
            <div class="bg-dark border border-gray-600 p-6">
              <h2 class="text-xl font-bold text-green-400 mb-4">
                <span class="text-danger">[</span>BASIC_INFORMATION<span class="text-danger">]</span>
              </h2>
              <div class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                    <div class="text-sm text-secondary mb-1">FAMILY_NAME:</div>
                    <div class="text-green-400">{{ malware?.malware_info.family }}</div>
                  </div>
                  <div>
                    <div class="text-sm text-secondary mb-1">CATEGORY:</div>
                    <div class="text-warning">{{ malware?.category.toUpperCase() }}</div>
                  </div>
                </div>

                <div>
                  <div class="text-sm text-secondary mb-2">DESCRIPTION:</div>
                  <div class="text-muted leading-relaxed">{{ malware?.malware_info.description }}</div>
                </div>

                <div v-if="malware?.malware_info.aliases && malware?.malware_info.aliases.length > 0">
                  <div class="text-sm text-secondary mb-2">ALIASES:</div>
                  <div class="flex flex-wrap gap-2">
                    <span
                      v-for="alias in malware.malware_info.aliases"
                      :key="alias"
                      class="bg-darker border border-gray-600 text-green-400 px-2 py-1 text-xs"
                    >
                      {{ alias }}
                    </span>
                  </div>
                </div>

                <div v-if="malware?.primary_tags && malware?.primary_tags.length > 0">
                  <div class="text-sm text-secondary mb-2">TAGS:</div>
                  <div class="flex flex-wrap gap-2">
                    <span
                      v-for="tag in malware.primary_tags"
                      :key="tag"
                      class="bg-darker border border-green-400 text-green-400 px-2 py-1 text-xs"
                    >
                      {{ tag }}
                    </span>
                  </div>
                </div>
              </div>
            </div>

            
            <div class="bg-dark border border-gray-600 p-6">
              <h2 class="text-xl font-bold text-green-400 mb-4">
                <span class="text-danger">[</span>MUTEX_SIGNATURES<span class="text-danger">]</span>
                <span class="text-warning ml-2">({{ malware?.mutexes.length }})</span>
              </h2>
              <div class="space-y-4">
                <div
                  v-for="(mutex, index) in malware?.mutexes"
                  :key="mutex.name"
                  class="bg-darker border border-gray-600 p-4"
                >
                  <div class="flex items-start justify-between mb-2">
                    <div class="text-sm text-secondary">
                      <span class="text-danger">[</span>MUTEX_{{ (index + 1).toString().padStart(2, '0') }}<span class="text-danger">]</span>
                    </div>
                    <button
                      @click="copyMutex(mutex.name)"
                      class="interactive text-secondary hover:text-green-400 text-xs"
                      title="Copy mutex name"
                    >
                      <span class="text-danger">[</span>COPY<span class="text-danger">]</span>
                    </button>
                  </div>
                  <div class="font-mono text-sm bg-black border border-green-400 p-3 text-green-400 mb-2">
                    {{ mutex.name }}
                  </div>
                  <div class="flex items-center gap-4 text-xs text-secondary mb-2">
                    <span>
                      ANALYST: <span class="text-warning">{{ mutex.analyst }}</span>
                    </span>
                    <span>
                      DATE: <span class="text-warning">{{ mutex.date_added }}</span>
                    </span>
                  </div>
                  <div v-if="mutex.references && mutex.references.length > 0" class="text-xs text-secondary">
                    <div class="mb-1">REFERENCES:</div>
                    <div class="space-y-1">
                      <div
                        v-for="reference in mutex.references"
                        :key="reference"
                        class="ml-2"
                      >
                        <a
                          :href="reference"
                          target="_blank"
                          rel="noopener noreferrer"
                          class="text-blue-400 hover:text-blue-300 underline break-all"
                        >
                          {{ reference }}
                        </a>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          
          <div class="space-y-6">
            
            <!-- Quick Actions -->
            <div class="bg-dark border border-gray-600 p-6">
              <h3 class="text-lg font-bold text-green-400 mb-4">
                <span class="text-danger">[</span>QUICK_ACTIONS<span class="text-danger">]</span>
              </h3>
              <div class="space-y-3">
                <button
                  @click="downloadJson"
                  class="btn btn-primary w-full p-3 text-xs"
                >
                  <span class="text-danger">[</span>DOWNLOAD_JSON<span class="text-danger">]</span>
                </button>
                <button
                  @click="copyMutexes"
                  class="btn btn-outline w-full p-3 text-xs"
                >
                  <span class="text-danger">[</span>COPY_ALL_MUTEXES<span class="text-danger">]</span>
                </button>
              </div>
            </div>

            <!-- Threat Intelligence -->
            <div v-if="malware?.malware_info.threat_actor" class="bg-dark border border-gray-600 p-6">
              <h3 class="text-lg font-bold text-green-400 mb-4">
                <span class="text-danger">[</span>THREAT_INTELLIGENCE<span class="text-danger">]</span>
              </h3>
              <div class="space-y-4">
                <div>
                  <div class="text-sm text-secondary mb-2">ATTRIBUTION:</div>
                  <div class="space-y-2">
                    <div
                      v-for="actor in getThreatActors(malware.malware_info.threat_actor)"
                      :key="actor"
                      class="bg-danger border border-red-500 p-3 rounded"
                    >
                      <div class="flex items-center gap-2">
                        <span class="text-red-400 text-lg">⚠</span>
                        <span class="text-red-400 font-bold text-sm">{{ actor }}</span>
                      </div>
                    </div>
                  </div>
                </div>
                <div v-if="malware?.malware_info.first_seen">
                  <div class="text-sm text-secondary mb-1">FIRST_OBSERVED:</div>
                  <div class="text-warning font-mono">{{ malware?.malware_info.first_seen }}</div>
                </div>
              </div>
            </div>

            <!-- Sigma Rule -->
            <div class="bg-dark border border-gray-600 p-6">
              <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-bold text-green-400">
                  <span class="text-danger">[</span>SIGMA_RULE<span class="text-danger">]</span>
                </h3>
                <div class="flex items-center gap-2">
                  <button
                    @click="copySigmaRule"
                    class="interactive text-secondary hover:text-green-400 text-xs"
                    title="Copy Sigma rule"
                  >
                    <span class="text-danger">[</span>COPY<span class="text-danger">]</span>
                  </button>
                </div>
              </div>

              <div class="bg-black border border-green-400 p-4 max-h-[400px] overflow-y-auto">
                <pre class="text-xs text-green-400 whitespace-pre-wrap font-mono leading-relaxed">{{ sigmaRuleContent }}</pre>
              </div>
              
              <div class="mt-4 flex justify-center">
                <button
                  @click="downloadSigmaRule"
                  class="btn btn-primary px-6 py-3 text-sm font-bold"
                  title="Download Sigma rule"
                >
                  <span class="text-danger">[</span>DOWNLOAD_SIGMA_RULE<span class="text-danger">]</span>
                </button>
              </div>
            </div>

            
            <!-- Statistics -->
            <div class="bg-dark border border-gray-600 p-6">
              <h3 class="text-lg font-bold text-green-400 mb-4">
                <span class="text-danger">[</span>STATISTICS<span class="text-danger">]</span>
              </h3>
              <div class="space-y-3">
                <div class="flex justify-between items-center">
                  <span class="text-sm text-secondary">MUTEX_COUNT:</span>
                  <span class="text-warning">{{ malware?.mutexes.length }}</span>
                </div>
                <div class="flex justify-between items-center">
                  <span class="text-sm text-secondary">THREAT_ACTORS:</span>
                  <span class="text-red-400">{{ malware?.malware_info.threat_actor ? getThreatActors(malware.malware_info.threat_actor).length : 0 }}</span>
                </div>
                <div class="flex justify-between items-center">
                  <span class="text-sm text-secondary">ALIASES:</span>
                  <span class="text-warning">{{ malware?.malware_info.aliases ? malware.malware_info.aliases.length : 0 }}</span>
                </div>
                <div class="flex justify-between items-center">
                  <span class="text-sm text-secondary">TAGS:</span>
                  <span class="text-warning">{{ malware?.primary_tags.length }}</span>
                </div>
                <div class="flex justify-between items-center">
                  <span class="text-sm text-secondary">CATEGORY:</span>
                  <span class="text-danger">{{ malware?.category.toUpperCase() }}</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        
        <div class="border-t border-gray-600 pt-4 mt-8">
          <div class="text-sm text-muted">
            Malware profile loaded successfully
          </div>
        </div>
      </div>
    </div>
  </div>
</template>

<script setup>
import { ref, computed, onMounted } from 'vue'

// Add this to your [slug].vue file
const route = useRoute()
const router = useRouter()

// For SSG, we need to fetch data during build time or from the store
let malwareStore = null
const malware = ref(null)

// SEO meta tags setup - moved to top for better SSG support
const sigmaRuleContent = ref('')

const findMalwareBySlug = (slug) => {
  if (!malwareStore || !malwareStore.malwareList) return null
  return malwareStore.malwareList.find(m =>
    m.malware_info.family.toLowerCase().replace(/\s+/g, '-') === slug
  )
}

const getThreatActors = (threatActor) => {
  if (!threatActor) return []
  if (Array.isArray(threatActor)) {
    return threatActor
  }
  return [threatActor]
}

const goBack = () => {
  router.back()
}

const copyMutex = async (mutexName) => {
  try {
    await navigator.clipboard.writeText(mutexName)
    showNotification('Mutex copied to clipboard', 'success')
  } catch (error) {
    console.error('Failed to copy mutex:', error)
    showNotification('Failed to copy mutex', 'error')
  }
}

const copyMutexes = async () => {
  if (!malware.value) return

  try {
    const mutexes = malware.value.mutexes.map(m => m.name).join('\n')
    await navigator.clipboard.writeText(mutexes)
    showNotification('All mutexes copied to clipboard', 'success')
  } catch (error) {
    console.error('Failed to copy mutexes:', error)
    showNotification('Failed to copy mutexes', 'error')
  }
}

const downloadJson = () => {
  if (!malware.value) return

  const blob = new Blob([JSON.stringify(malware.value, null, 2)], { type: 'application/json' })
  const url = URL.createObjectURL(blob)
  const a = document.createElement('a')
  a.href = url
        a.download = `${malware.value.malware_info.family.toLowerCase().replace(/\s+/g, '-')}.json`
  a.click()
  URL.revokeObjectURL(url)
  showNotification('JSON file downloaded', 'success')
}

const downloadSigmaRule = async () => {
  if (!malware.value) return

  try {
    const sigmaRule = await malwareStore.exportSigmaRule(malware.value)
    const blob = new Blob([sigmaRule], { type: 'text/yaml' })
    const url = URL.createObjectURL(blob)
    const a = document.createElement('a')
    a.href = url
          a.download = `${malware.value.malware_info.family.toLowerCase().replace(/\s+/g, '-')}-sigma-rule.yml`
    a.click()
    URL.revokeObjectURL(url)
    showNotification('Sigma rule downloaded', 'success')
  } catch (error) {
    console.error('Error downloading Sigma rule:', error)
    showNotification('Failed to download Sigma rule', 'error')
  }
}

const generateSigmaPreview = async () => {
  if (!malware.value) return

  try {
    const sigmaRule = await malwareStore.exportSigmaRule(malware.value)
    sigmaRuleContent.value = sigmaRule
  } catch (error) {
    console.error('Error generating Sigma rule preview:', error)
    sigmaRuleContent.value = '# Error generating Sigma rule preview\n# Please try downloading the rule directly'
  }
}

const copySigmaRule = async () => {
  if (!sigmaRuleContent.value) return
  try {
    await navigator.clipboard.writeText(sigmaRuleContent.value)
    showNotification('Sigma rule copied to clipboard', 'success')
  } catch (error) {
    console.error('Failed to copy Sigma rule:', error)
    showNotification('Failed to copy Sigma rule', 'error')
  }
}

const showNotification = (message, type = 'info') => {

  console.log(`[${type.toUpperCase()}] ${message}`)
}

onMounted(async () => {
  try {

    malwareStore = useMalwareStore()

    if (malwareStore && malwareStore.malwareList.length === 0) {
      await malwareStore.loadMalwareData()
    }

    const slug = route.params.slug
    malware.value = findMalwareBySlug(slug)

    if (!malware.value) {

      await navigateTo('/')
      return
    }

    await generateSigmaPreview()
  } catch (error) {
    console.error('Failed to initialize malware detail page:', error)
  }
})

// Enhanced SEO Meta Tags
useSeoMeta({
  title: computed(() => malware.value ? `${malware.value.malware_info.family} - EvilMutex Malware Analysis` : 'Malware Details - EvilMutex'),
  description: computed(() => malware.value ? `Comprehensive analysis of ${malware.value.malware_info.family} malware including ${malware.value.mutexes.length} mutex signatures for threat detection and cybersecurity research.` : 'Detailed malware information and mutex signatures for cybersecurity research.'),
  keywords: computed(() => malware.value ? `${malware.value.malware_info.family}, malware, mutex, cybersecurity, threat intelligence, ${malware.value.primary_tags.join(', ')}, ${malware.value.category}` : 'malware, mutex, cybersecurity, threat intelligence'),
  author: 'EvilMutex Team',
  ogTitle: computed(() => malware.value ? `${malware.value.malware_info.family} - EvilMutex Malware Analysis` : 'Malware Details - EvilMutex'),
  ogDescription: computed(() => malware.value ? `Comprehensive analysis of ${malware.value.malware_info.family} malware including ${malware.value.mutexes.length} mutex signatures for threat detection and cybersecurity research.` : 'Detailed malware information and mutex signatures for cybersecurity research.'),
  ogImage: 'https://evilmutex.org/og-image.png',
  ogUrl: computed(() => `https://evilmutex.org/malware/${route.params.slug}/`),
  ogType: 'article',
  twitterCard: 'summary_large_image',
  twitterTitle: computed(() => malware.value ? `${malware.value.malware_info.family} - EvilMutex Analysis` : 'Malware Details - EvilMutex'),
  twitterDescription: computed(() => malware.value ? `Analysis of ${malware.value.malware_info.family} malware with ${malware.value.mutexes.length} mutex signatures` : 'Detailed malware analysis'),
  twitterImage: 'https://evilmutex.org/og-image.png'
})

// Note: Structured data can be added via SEO modules later if needed
</script>

<style scoped>

pre::-webkit-scrollbar {
  width: 6px;
  height: 6px;
}

pre::-webkit-scrollbar-track {
  background: rgba(0, 0, 0, 0.3);
}

pre::-webkit-scrollbar-thumb {
  background: rgba(0, 255, 0, 0.5);
  border-radius: 3px;
}

pre::-webkit-scrollbar-thumb:hover {
  background: rgba(0, 255, 0, 0.7);
}
</style>