<template>
  <div class="bg-dark border border-gray-600 p-4 hover:border-green-400 transition-colors font-mono">
    
    <div class="flex justify-between items-start mb-4">
      <div>
        <h3 class="text-lg font-bold text-green-400 mb-1">
          <span class="text-danger">[</span>{{ malware.malware_info.family }}<span class="text-danger">]</span>
        </h3>
        <div class="text-xs text-muted">
          <span class="text-danger">ID:</span> {{ malware.malware_info.family.toLowerCase().replace(/\s+/g, '-') }}
        </div>
      </div>
      <div class="flex items-center gap-2">
        <span class="badge badge-red">{{ malware.category }}</span>
        <span class="text-warning text-sm">{{ malware.mutexes.length }} mutexes</span>
      </div>
    </div>

    
    <div class="mb-4">
      <p class="text-sm text-secondary line-clamp-2">
        {{ malware.malware_info.description }}
      </p>
    </div>

    
    <div class="mb-4" v-if="malware.malware_info.aliases && malware.malware_info.aliases.length > 0">
      <div class="text-xs text-muted mb-2">
        <span class="text-danger">ALIASES:</span>
      </div>
      <div class="flex flex-wrap gap-1">
        <span
          v-for="alias in malware.malware_info.aliases.slice(0, 3)"
          :key="alias"
          class="badge badge-gray text-xs"
        >
          {{ alias }}
        </span>
        <span
          v-if="malware.malware_info.aliases.length > 3"
          class="badge badge-gray text-xs"
        >
          +{{ malware.malware_info.aliases.length - 3 }} more
        </span>
      </div>
    </div>

    
    <div class="mb-4" v-if="malware.primary_tags && malware.primary_tags.length > 0">
      <div class="text-xs text-muted mb-2">
        <span class="text-danger">TAGS:</span>
      </div>
      <div class="flex flex-wrap gap-1">
        <span
          v-for="tag in malware.primary_tags.slice(0, 4)"
          :key="tag"
          class="badge badge-blue text-xs"
        >
          {{ tag }}
        </span>
        <span
          v-if="malware.primary_tags.length > 4"
          class="badge badge-blue text-xs"
        >
          +{{ malware.primary_tags.length - 4 }} more
        </span>
      </div>
    </div>

    
    <div class="mb-4">
      <div class="text-xs text-muted mb-2">
        <span class="text-danger">MUTEX_SIGNATURES:</span>
      </div>
      <div class="bg-darker border border-gray-600 p-3 max-h-24 overflow-y-auto">
        <div v-for="mutex in malware.mutexes.slice(0, 3)" :key="mutex.name" class="text-xs mb-1">
          <span class="text-green-400">{{ mutex.name }}</span>
          <span v-if="mutex.description" class="text-muted ml-2">- {{ mutex.description }}</span>
        </div>
        <div v-if="malware.mutexes.length > 3" class="text-xs text-muted">
          ... and {{ malware.mutexes.length - 3 }} more
        </div>
      </div>
    </div>

    
    <div class="flex gap-2">
      <NuxtLink
        :to="`/malware/${malware.malware_info.family.toLowerCase().replace(/\s+/g, '-')}`"
        class="btn btn-outline text-xs flex-1"
      >
        <Icon name="lucide:eye" class="w-3 h-3 mr-1" />
        VIEW
      </NuxtLink>
      <button
        @click="copyMutexes"
        class="btn btn-secondary text-xs"
        :disabled="copying"
      >
        <Icon name="lucide:copy" class="w-3 h-3 mr-1" />
        {{ copying ? 'COPIED' : 'COPY' }}
      </button>
      <button
        @click="downloadSigmaRule"
        class="btn btn-outline text-xs"
        :disabled="downloading"
      >
        <Icon name="lucide:download" class="w-3 h-3 mr-1" />
        {{ downloading ? 'DOWNLOADING' : 'SIGMA' }}
      </button>
    </div>

    
    <div class="mt-4 pt-3 border-t border-gray-600">
      <div class="text-xs text-muted">
        <span class="text-danger">root@evilmutex:~$</span>
        <span class="text-secondary">{{ formatDate(malware.created_at || new Date()) }}</span>
        <span class="text-muted ml-2">[ THREAT_PROFILE ]</span>
      </div>
    </div>
  </div>
</template>

<script setup>
import { ref } from 'vue'

const props = defineProps({
  malware: {
    type: Object,
    required: true
  }
})

const copying = ref(false)
const downloading = ref(false)

const copyMutexes = async () => {
  if (copying.value) return

  copying.value = true
  try {
    const mutexes = props.malware.mutexes.map(m => m.name).join('\n')
    await navigator.clipboard.writeText(mutexes)

    setTimeout(() => {
      copying.value = false
    }, 2000)
  } catch (error) {
    console.error('Failed to copy mutexes:', error)
    copying.value = false
  }
}

const downloadSigmaRule = async () => {
  if (downloading.value) return

  downloading.value = true
  try {
    const malwareStore = useMalwareStore()
    const sigmaRule = await malwareStore.exportSigmaRule(props.malware)

    const blob = new Blob([sigmaRule], { type: 'text/yaml' })
    const url = URL.createObjectURL(blob)
    const a = document.createElement('a')
    a.href = url
    a.download = `${props.malware.malware_info.family.toLowerCase().replace(/\s+/g, '-')}-sigma-rule.yml`
    a.click()
    URL.revokeObjectURL(url)

    setTimeout(() => {
      downloading.value = false
    }, 2000)
  } catch (error) {
    console.error('Failed to download Sigma rule:', error)
    downloading.value = false
  }
}

const formatDate = (date) => {
  return new Date(date).toLocaleDateString('en-US', {
    year: 'numeric',
    month: '2-digit',
    day: '2-digit'
  }).replace(/\//g, '-')
}
</script>

<style scoped>
.line-clamp-2 {
  display: -webkit-box;
  -webkit-line-clamp: 2;
  line-clamp: 2; /* Standard property for compatibility */
  -webkit-box-orient: vertical;
  overflow: hidden;
}

.max-h-24::-webkit-scrollbar {
  width: 4px;
}

.max-h-24::-webkit-scrollbar-track {
  background: var(--bg-secondary);
}

.max-h-24::-webkit-scrollbar-thumb {
  background: var(--bg-accent);
  border: 1px solid var(--border-color);
}

.max-h-24::-webkit-scrollbar-thumb:hover {
  background: var(--border-active);
}

.hover\:border-green-400:hover {
  border-color: var(--border-active);
  box-shadow: 0 0 0 1px var(--glow-color);
}

.btn:disabled {
  opacity: 0.6;
  cursor: not-allowed;
}

.btn:disabled:hover {
  transform: none;
  box-shadow: none;
}

.badge:hover {
  transform: scale(1.05);
}

.btn .lucide {
  margin-right: 0.25rem;
}
</style>